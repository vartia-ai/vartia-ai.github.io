# .github/workflows/publish.yml
name: Quarto Publish
on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git init .
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote add origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
          git fetch --depth=1 origin "${GITHUB_SHA}"
          git checkout FETCH_HEAD

      - name: Install Quarto CLI
        env:
          QUARTO_VERSION: "1.4.553"
        run: |
          curl -L "https://github.com/quarto-dev/quarto-cli/releases/download/v${QUARTO_VERSION}/quarto-${QUARTO_VERSION}-linux-amd64.deb" -o /tmp/quarto.deb
          sudo dpkg -i /tmp/quarto.deb
          quarto --version

      - name: Render site
        run: quarto render

      - name: Prepare publish directory
        run: |
          # Preserve custom domain configuration and disable Jekyll processing
          cp CNAME _site/CNAME 2>/dev/null || true
          touch _site/.nojekyll

      - name: Deploy to gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          ACTOR: ${{ github.actor }}
          SHA: ${{ github.sha }}
        run: |
          cd _site
          git init
          git config user.name "${ACTOR}"
          git config user.email "${ACTOR}@users.noreply.github.com"
          git add .
          git commit -m "Deploy ${SHA}"
          git branch -M gh-pages
          git remote add origin https://x-access-token:${GITHUB_TOKEN}@github.com/${REPO}.git
          git push --force origin gh-pages
